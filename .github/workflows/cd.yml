# Continuous Deployment Pipeline
# Deploys to Hugging Face Spaces on merge to main

name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

env:
  HF_SPACE: Hustledaniel/OncologyDetection

jobs:
  # ============================================================================
  # Deploy to Hugging Face Spaces
  # ============================================================================
  deploy-hf-spaces:
    name: Deploy to HF Spaces
    runs-on: ubuntu-latest
    # Only run after CI passes
    needs: []
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install huggingface_hub

      - name: Deploy to Hugging Face Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python - <<EOF
          from huggingface_hub import HfApi
          import os
          
          api = HfApi()
          
          # Upload entire repository to HF Space
          api.upload_folder(
              folder_path=".",
              repo_id="${{ env.HF_SPACE }}",
              repo_type="space",
              token=os.environ["HF_TOKEN"],
              ignore_patterns=[
                  ".git/*",
                  ".github/*",
                  "__pycache__/*",
                  "*.pyc",
                  ".pytest_cache/*",
                  ".mypy_cache/*",
                  ".ruff_cache/*",
                  "logs/*",
                  ".env",
                  "*.log"
              ]
          )
          print(f"‚úÖ Deployed to https://huggingface.co/spaces/${{ env.HF_SPACE }}")
          EOF

      - name: Verify deployment
        run: |
          echo "üöÄ Deployment triggered for ${{ env.HF_SPACE }}"
          echo "üìç View at: https://huggingface.co/spaces/${{ env.HF_SPACE }}"

  # ============================================================================
  # Create GitHub Release (on tags)
  # ============================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.version.outputs.VERSION }}
          body: |
            ## Oncology irAE Detection Assistant v${{ steps.version.outputs.VERSION }}
            
            ### What's New
            - See [CHANGELOG.md](CHANGELOG.md) for details
            
            ### Installation
            ```bash
            pip install -r requirements.txt
            ```
            
            ### Run
            ```bash
            # Streamlit App
            streamlit run app/main.py
            
            # API Server
            uvicorn api_server:app --host 0.0.0.0 --port 8000
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Notify on Deployment
  # ============================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-hf-spaces]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy-hf-spaces.result }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
            echo "üîó https://huggingface.co/spaces/${{ env.HF_SPACE }}"
          else
            echo "‚ùå Deployment failed"
            exit 1
          fi
